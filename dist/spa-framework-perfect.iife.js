var PerfectSPAFramework=function(){"use strict";class t{constructor(t){this.eventSource=null,this.serviceWorker=null,this.performanceObserver=null,this.cache=new Map,this.config=this.mergeWithDefaults(t),this.detectEnvironment(),this.initializeServices(),this.init()}detectEnvironment(){const t="undefined"!=typeof window?window:global;this.config.ai={CLAUDE_CODE:!!t.claude||"true"===process.env.CLAUDE_ENV,GEMINI:!(!process.env.GEMINI_API_KEY&&"gemini"!==process.env.AI_ASSISTANT),HYBRID:"true"===process.env.AI_COLLABORATION,environment:process.env.NODE_ENV||"development"}}initializeServices(){this.analytics=new i(this.config),this.security=new e(this.config.security),this.aiCollaboration=new r(this.config.ai)}async init(){try{await this.initializeCore(),this.config.performance.bundleOptimization&&this.initPerformanceMonitoring(),this.config.performance.serviceWorker&&await this.initServiceWorker(),(this.config.security.csrf||this.config.security.csp)&&this.security.initialize(),this.config.ai.HYBRID&&await this.aiCollaboration.initialize(),await this.initializeFeatures(),this.analytics.track("spa_initialized",{version:"2.0"})}catch(t){this.handleError(t,"initialization")}}async initializeCore(){await this.initSSEWithRetry(),this.initEnhancedForms(),this.initSmartCaching(),this.initErrorBoundaries()}async initSSEWithRetry(t=5,i=1e3){for(let r=1;r<=t;r++)try{return void(await this.initSSE())}catch(e){if(r===t)throw new Error(`SSE connection failed after ${t} attempts`);await this.sleep(i*Math.pow(2,r-1))}}initSSE(){return new Promise((t,i)=>{if(this.config.workSetId)try{this.eventSource=new EventSource(`${this.config.sseUrl}/sse/${this.config.workSetId}`);const e=setTimeout(()=>{i(new Error("SSE connection timeout"))},1e4);this.eventSource.onopen=()=>{clearTimeout(e),this.analytics.track("sse_connected"),t()},this.eventSource.onmessage=t=>{this.handleSSEMessage(JSON.parse(t.data))},this.eventSource.onerror=t=>{clearTimeout(e),this.analytics.track("sse_error",{error:t.toString()}),i(t)}}catch(e){i(e)}else t()})}initEnhancedForms(){document.addEventListener("submit",async t=>{const i=t.target;if(!i.hasAttribute("data-spa-ignore")){t.preventDefault();try{if(!(await this.validateForm(i)))return;this.config.security.sanitization&&this.security.sanitizeFormData(i),await this.submitFormWithAnalytics(i)}catch(e){this.handleError(e,"form_submission")}}})}async validateForm(t){const i=new FormData(t);let e=!0;for(const[r,s]of i.entries())"string"==typeof s&&(this.security.detectXSS(s)&&(this.showNotification(`不正な入力が検出されました: ${r}`,"error"),e=!1),this.security.detectSQLInjection(s)&&(this.showNotification(`不正なクエリが検出されました: ${r}`,"error"),e=!1));return e}initSmartCaching(){const t=this.config.performance.caching;this.interceptAPIRequests((i,e)=>{if(t.api>0){const r=this.generateCacheKey(i);this.cache.set(r,{data:e,timestamp:Date.now(),ttl:1e3*t.api}),setTimeout(()=>{this.cache.delete(r)},1e3*t.api)}})}initPerformanceMonitoring(){"PerformanceObserver"in window&&(this.performanceObserver=new PerformanceObserver(t=>{for(const i of t.getEntries())this.analytics.trackPerformance(i)}),this.performanceObserver.observe({entryTypes:["navigation","paint","largest-contentful-paint","first-input","layout-shift"]})),this.trackCustomMetrics()}async initServiceWorker(){if("serviceWorker"in navigator)try{this.serviceWorker=await navigator.serviceWorker.register("/sw.js"),this.serviceWorker.addEventListener("updatefound",()=>{const t=this.serviceWorker.installing;t&&t.addEventListener("statechange",()=>{"installed"===t.state&&this.showNotification("新しいバージョンが利用可能です","info")})})}catch(t){}}async initializeFeatures(){const t=this.config.features;t.pwa&&await this.initPWA(),t.a11y&&this.initAccessibility(),t.darkMode&&this.initDarkMode(),t.offline&&await this.initOfflineSupport()}handleError(t,i){const e={timestamp:new Date,userAgent:navigator.userAgent,url:window.location.href,sessionId:this.generateSessionId(),aiAssistant:this.getActiveAIAssistant()};this.analytics.trackError(t,e),this.config.ai.HYBRID&&this.aiCollaboration.analyzeError(t,e),this.showNotification("エラーが発生しました。しばらくお待ちください。","error")}getActiveAIAssistant(){const t=this.config.ai;return t.HYBRID?"claude+gemini":t.CLAUDE_CODE?"claude-code":t.GEMINI?"gemini":"none"}sleep(t){return new Promise(i=>setTimeout(i,t))}generateCacheKey(t){return`spa_cache_${btoa(t)}_${this.config.workSetId}`}generateSessionId(){return`spa_session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}mergeWithDefaults(t){return{workSetId:t.workSetId||"",baseUrl:t.baseUrl||"",sseUrl:t.sseUrl||"http://localhost:3005",debug:t.debug||!1,ai:t.ai||{},performance:{bundleOptimization:!0,lazyLoading:!0,caching:{api:300,static:3600,strategy:"stale-while-revalidate"},preloading:!0,serviceWorker:!0,...t.performance},security:{csrf:!0,csp:!0,sanitization:!0,encryption:!1,rateLimiting:{api:100,sse:5,enabled:!0},...t.security},features:{offline:!0,pwa:!0,analytics:!0,a11y:!0,darkMode:!0,...t.features}}}handleSSEMessage(t){}showNotification(t,i){}submitFormWithAnalytics(t){return Promise.resolve()}interceptAPIRequests(t){}trackCustomMetrics(){}initPWA(){return Promise.resolve()}initAccessibility(){}initDarkMode(){}initOfflineSupport(){return Promise.resolve()}initErrorBoundaries(){}}class i{constructor(t){this.config=t}track(t,i){this.config.debug}trackError(t,i){this.track("error",{error:t.message,context:i})}trackPerformance(t){this.track("performance",{name:t.name,duration:t.duration,startTime:t.startTime})}}class e{constructor(t){this.config=t}initialize(){this.config.csp&&this.setupCSP(),this.config.csrf&&this.setupCSRF()}detectXSS(t){return[/<script/i,/javascript:/i,/on\w+=/i].some(i=>i.test(t))}detectSQLInjection(t){return[/union\s+select/i,/drop\s+table/i,/insert\s+into/i,/delete\s+from/i].some(i=>i.test(t))}sanitizeFormData(t){}setupCSP(){}setupCSRF(){}}class r{constructor(t){this.ai=t}async initialize(){}async analyzeError(t,i){this.ai.GEMINI,this.ai.CLAUDE_CODE}}return"undefined"!=typeof window&&(window.PerfectSPAFramework=t),t}();
